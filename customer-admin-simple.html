<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ValuesAlign - Customer Admin Dashboard</title>
    <link rel="stylesheet" href="css/styles.css?v=1.9.10&t=20250322083504">
    <style>
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 2rem 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #e74c3c;
            background-color: #fadbd8;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ValuesAlign</h1>
            <p>Customer Admin Dashboard</p>
        </header>
        
        <section id="login-section">
            <div class="card">
                <h2>Customer Admin Login</h2>
                <p>Please enter your credentials to access the dashboard.</p>
                
                <form id="login-form">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="github-token">GitHub Token</label>
                        <input type="password" id="github-token" name="github-token" required>
                        <p class="help-text">Enter your GitHub Personal Access Token to access the repository.</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="login-button" class="btn primary">Login</button>
                    </div>
                </form>
            </div>
        </section>
        
        <section id="dashboard-section" class="hidden">
            <div class="card">
                <h2>Welcome, <span id="user-display">User</span></h2>
                <p>You are logged in as a customer admin.</p>
                
                <div id="values-container">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <p>Loading values...</p>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button id="logout-button" class="btn secondary">Logout</button>
                </div>
            </div>
        </section>
        
        <footer>
            <p>&copy; 2025 ValuesAlign. All rights reserved. <span id="app-version">v1.9.10</span></p>
        </footer>
    </div>
    
    <script>
        // Configuration
        const config = {
            github: {
                owner: 'blortski',
                repo: 'candidate-values-survey',
                branch: 'main'
            },
            version: 'v1.9.10'
        };
        
        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const valuesContainer = document.getElementById('values-container');
        const userDisplay = document.getElementById('user-display');
        const versionElement = document.getElementById('app-version');
        
        // GitHub API Class
        class GitHubAPI {
            constructor(options) {
                this.token = options.token || '';
                this.owner = options.owner || '';
                this.repo = options.repo || '';
                this.branch = options.branch || 'main';
                
                console.log('GitHubAPI initialized with:', {
                    owner: this.owner,
                    repo: this.repo,
                    branch: this.branch,
                    token: this.token ? 'provided' : 'not provided'
                });
            }
            
            isConfigured() {
                return this.token && this.owner && this.repo;
            }
            
            async testAccess() {
                console.log('GitHubAPI.testAccess: Testing GitHub API access...');
                
                if (!this.isConfigured()) {
                    console.error('GitHubAPI.testAccess: GitHub API is not configured. Please set a token.');
                    return false;
                }
                
                try {
                    // Test access by trying to get the repository details
                    const response = await fetch(`https://api.github.com/repos/${this.owner}/${this.repo}`, {
                        headers: {
                            'Authorization': `token ${this.token}`
                        }
                    });
                    
                    if (!response.ok) {
                        console.error(`GitHubAPI.testAccess: Failed to access GitHub API. Status: ${response.status}`);
                        return false;
                    }
                    
                    console.log('GitHubAPI.testAccess: GitHub API access successful');
                    return true;
                } catch (error) {
                    console.error('GitHubAPI.testAccess: Error testing GitHub API access:', error);
                    return false;
                }
            }
            
            async getFileContent(path) {
                console.log(`GitHubAPI.getFileContent: Getting file content for path: ${path}`);
                
                if (!this.isConfigured()) {
                    throw new Error('GitHub API is not configured. Please set a token.');
                }
                
                try {
                    const url = `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${path}?ref=${this.branch}`;
                    console.log('GitHubAPI.getFileContent: Fetching from URL:', url);
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${this.token}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('GitHubAPI.getFileContent: Error response:', errorData);
                        throw new Error(`Failed to get file content: ${errorData.message}`);
                    }
                    
                    const data = await response.json();
                    console.log('GitHubAPI.getFileContent: File content received');
                    return data;
                } catch (error) {
                    console.error('GitHubAPI.getFileContent: Error getting file content:', error);
                    throw error;
                }
            }
        }
        
        // Global variables
        let customerId = null;
        let githubAPI = null;
        let valuesData = [];
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing customer admin dashboard v1.9.10...');
            
            // Set version in footer
            if (versionElement) {
                versionElement.textContent = config.version;
                console.log('Set version to:', config.version);
            }
            
            // Get customer ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            customerId = urlParams.get('id');
            
            if (!customerId) {
                showError('Customer ID not found in URL. Please access this page with a valid customer ID parameter (e.g., ?id=1).');
                return;
            }
            
            console.log('Customer ID from URL:', customerId);
            
            // Set up event listeners
            loginButton.addEventListener('click', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            
            // Check if user is already logged in
            checkLoginStatus();
        });
        
        /**
         * Handle login form submission
         */
        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const token = document.getElementById('github-token').value.trim();
            
            console.log('Login attempt with:', { email, token: token ? 'provided' : 'not provided' });
            
            if (!email || !password || !token) {
                showError('Please enter your email, password, and GitHub token.');
                return;
            }
            
            // Initialize GitHub API
            githubAPI = new GitHubAPI({
                token: token,
                owner: config.github.owner,
                repo: config.github.repo,
                branch: config.github.branch
            });
            
            console.log('GitHub API initialized with config:', {
                owner: config.github.owner,
                repo: config.github.repo,
                branch: config.github.branch
            });
            
            // Test GitHub API connection
            try {
                console.log('Testing GitHub API connection...');
                const isValid = await githubAPI.testAccess();
                console.log('GitHub API connection test result:', isValid);
                
                if (isValid) {
                    // Verify customer admin credentials
                    console.log('Verifying customer admin credentials...');
                    const isAuthorized = await verifyCustomerAdmin(email, password);
                    console.log('Customer admin verification result:', isAuthorized);
                    
                    if (isAuthorized) {
                        // Save credentials to localStorage
                        localStorage.setItem('github_token', token);
                        localStorage.setItem('customer_admin_email', email);
                        console.log('Credentials saved to localStorage');
                        
                        // Show dashboard
                        showDashboard(email);
                        
                        // Load data
                        loadValuesData();
                    } else {
                        showError('Invalid email or password.');
                    }
                } else {
                    showError('Invalid GitHub token or repository access.');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Error connecting to GitHub: ' + error.message);
            }
        }
        
        /**
         * Handle logout button click
         */
        function handleLogout() {
            // Clear credentials from localStorage
            localStorage.removeItem('github_token');
            localStorage.removeItem('customer_admin_email');
            
            // Show login section
            loginSection.classList.remove('hidden');
            dashboardSection.classList.add('hidden');
        }
        
        /**
         * Check if the user is already logged in
         */
        function checkLoginStatus() {
            const token = localStorage.getItem('github_token');
            const email = localStorage.getItem('customer_admin_email');
            
            console.log('Checking login status:', { 
                token: token ? 'exists' : 'not found', 
                email: email ? email : 'not found' 
            });
            
            if (token && email) {
                // Initialize GitHub API
                githubAPI = new GitHubAPI({
                    token: token,
                    owner: config.github.owner,
                    repo: config.github.repo,
                    branch: config.github.branch
                });
                
                // Show dashboard
                showDashboard(email);
                
                // Load data
                loadValuesData();
            }
        }
        
        /**
         * Show the dashboard
         * @param {string} email - The admin email to display
         */
        function showDashboard(email) {
            // Hide login section
            loginSection.classList.add('hidden');
            
            // Show dashboard section
            dashboardSection.classList.remove('hidden');
            
            // Update user display
            userDisplay.textContent = email;
        }
        
        /**
         * Show an error message
         * @param {string} message - The error message to display
         */
        function showError(message) {
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.textContent = message;
            
            // Remove any existing error messages
            const existingErrors = document.querySelectorAll('.error-message');
            existingErrors.forEach(error => error.remove());
            
            // Add the new error message
            loginForm.insertBefore(errorElement, loginForm.firstChild);
            
            // Remove the error message after 5 seconds
            setTimeout(() => {
                errorElement.remove();
            }, 5000);
        }
        
        /**
         * Verify customer admin credentials
         * @param {string} email - The admin email
         * @param {string} password - The admin password
         * @returns {Promise<boolean>} - Promise resolving to true if authorized, false otherwise
         */
        async function verifyCustomerAdmin(email, password) {
            try {
                // Get customers data from GitHub
                const customersResponse = await githubAPI.getFileContent('data/customers.json');
                const customers = JSON.parse(atob(customersResponse.content));
                
                console.log('Customers data:', customers);
                
                // Find customer by ID
                const customer = customers.find(c => c.id === customerId);
                
                if (!customer) {
                    console.error('Customer not found:', customerId);
                    return false;
                }
                
                console.log('Found customer:', customer);
                
                // Verify admin credentials
                if (customer.adminEmail === email && customer.adminPassword === password) {
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Error verifying customer admin:', error);
                return false;
            }
        }
        
        /**
         * Load values data from GitHub
         */
        async function loadValuesData() {
            console.log('Loading values data...');
            console.log('Customer ID:', customerId);
            
            // Show loading indicator
            valuesContainer.innerHTML = `
                <div class="loading-indicator">
                    <div class="spinner"></div>
                    <p>Loading values...</p>
                </div>
            `;
            
            try {
                // Get values data from GitHub
                const valuesPath = `data/customers/${customerId}/values.json`;
                console.log('Attempting to load values from path:', valuesPath);
                
                const valuesResponse = await githubAPI.getFileContent(valuesPath);
                console.log('Values response received:', valuesResponse);
                
                valuesData = JSON.parse(atob(valuesResponse.content));
                console.log('Parsed values data:', valuesData);
                
                // Display values
                displayValues(valuesData);
            } catch (error) {
                console.error('Error loading values data:', error);
                valuesContainer.innerHTML = `<p class="error-message">Error loading values: ${error.message}</p>`;
            }
        }
        
        /**
         * Display values in the UI
         * @param {Object} data - The values data to display
         */
        function displayValues(data) {
            if (!data || !data.values || data.values.length === 0) {
                valuesContainer.innerHTML = '<p>No values found for this customer.</p>';
                return;
            }
            
            const valuesHtml = data.values.map(value => `
                <div class="card">
                    <h3>${value.name}</h3>
                    <p>${value.description}</p>
                    <p>Status: ${value.enabled ? 'Enabled' : 'Disabled'}</p>
                </div>
            `).join('');
            
            valuesContainer.innerHTML = `
                <h2>Company Values</h2>
                <p>Last updated: ${new Date(data.lastUpdated).toLocaleString()}</p>
                ${valuesHtml}
            `;
        }
    </script>
</body>
</html>
