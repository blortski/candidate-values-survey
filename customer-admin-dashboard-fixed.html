<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ValuesAlign - Customer Admin Dashboard</title>
    <link rel="stylesheet" href="css/styles.css?v=1.9.6&t=20250321210000">
    <style>
        /* Additional styles specific to the customer admin dashboard */
        .customer-header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        
        .customer-header h2 {
            margin: 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-nav {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }
        
        .tab-nav button {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
        }
        
        .tab-nav button.active {
            border-bottom: 3px solid #3498db;
            font-weight: bold;
        }
        
        .value-card, .employee-card, .survey-card {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .value-card h3, .employee-card h3, .survey-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .value-card .description, .employee-card .details, .survey-card .details {
            margin-bottom: 1rem;
            color: #555;
        }
        
        .value-card .actions, .employee-card .actions, .survey-card .actions {
            display: flex;
            justify-content: flex-end;
        }
        
        .value-card .actions button, .employee-card .actions button, .survey-card .actions button {
            margin-left: 0.5rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-badge.enabled {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-badge.disabled {
            background-color: #e74c3c;
            color: white;
        }
        
        .status-badge.sent {
            background-color: #3498db;
            color: white;
        }
        
        .status-badge.completed {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-badge.pending {
            background-color: #f39c12;
            color: white;
        }
        
        .modal-content {
            max-width: 800px;
        }
        
        .question-list {
            margin-top: 1rem;
        }
        
        .question-item {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .question-item h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .question-item .actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        
        .question-item .actions button {
            margin-left: 0.5rem;
        }
        
        .answer-options {
            margin-top: 0.5rem;
        }
        
        .answer-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .answer-option span {
            margin-right: 0.5rem;
            font-weight: bold;
        }
        
        .survey-results {
            margin-top: 1rem;
        }
        
        .result-item {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .result-item h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .result-item .score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .result-chart {
            margin-top: 1rem;
            height: 300px;
        }
        
        .print-button {
            margin-top: 1rem;
        }
        
        @media print {
            .container {
                width: 100%;
                max-width: none;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            .result-item {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ValuesAlign</h1>
            <p>Customer Admin Dashboard</p>
        </header>
        
        <section id="login-section">
            <div class="card">
                <h2>Customer Admin Login</h2>
                <p>Please enter your credentials to access the dashboard.</p>
                
                <form id="login-form">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="github-token">GitHub Token</label>
                        <input type="password" id="github-token" name="github-token" required>
                        <p class="help-text">Enter your GitHub Personal Access Token to access the repository.</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="login-button" class="btn primary">Login</button>
                    </div>
                </form>
            </div>
        </section>
        
        <section id="dashboard-section" style="display: none;">
            <div class="customer-header">
                <h2 id="company-name">Your Company</h2>
                <p>Customer Admin Dashboard</p>
            </div>
            
            <div class="tab-nav">
                <button id="values-tab-button" class="active">Values</button>
                <button id="employees-tab-button">Employees</button>
                <button id="surveys-tab-button">Surveys</button>
                <button id="results-tab-button">Results</button>
            </div>
            
            <div id="values-tab" class="tab-content active">
                <div class="section-header">
                    <h2>Company Values</h2>
                    <button id="add-value-button" class="btn primary">Add Value</button>
                </div>
                
                <div id="values-container">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <p>Loading values...</p>
                    </div>
                </div>
            </div>
            
            <div id="employees-tab" class="tab-content">
                <div class="section-header">
                    <h2>Employees</h2>
                    <button id="add-employee-button" class="btn primary">Add Employee</button>
                </div>
                
                <div id="employees-container">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <p>Loading employees...</p>
                    </div>
                </div>
            </div>
            
            <div id="surveys-tab" class="tab-content">
                <div class="section-header">
                    <h2>Surveys</h2>
                    <button id="create-survey-button" class="btn primary">Create Survey</button>
                </div>
                
                <div id="surveys-container">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <p>Loading surveys...</p>
                    </div>
                </div>
            </div>
            
            <div id="results-tab" class="tab-content">
                <div class="section-header">
                    <h2>Survey Results</h2>
                </div>
                
                <div id="results-container">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <p>Loading results...</p>
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button id="logout-button" class="btn secondary">Logout</button>
            </div>
        </section>
        
        <!-- Add Value Modal -->
        <div id="add-value-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Value</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="add-value-form">
                        <input type="hidden" id="value-id">
                        
                        <div class="form-group">
                            <label for="value-name">Value Name</label>
                            <input type="text" id="value-name" name="value-name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="value-description">Description</label>
                            <textarea id="value-description" name="value-description" rows="4" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="value-enabled">Enabled</label>
                            <select id="value-enabled" name="value-enabled">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="save-value-button" class="btn primary">Save</button>
                            <button type="button" class="btn secondary close-modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Questions Modal -->
        <div id="questions-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Questions for <span id="value-title"></span></h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="section-header">
                        <button type="button" id="add-question-button" class="btn primary">Add Question</button>
                    </div>
                    
                    <div id="questions-container">
                        <div class="loading-indicator">
                            <div class="spinner"></div>
                            <p>Loading questions...</p>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn secondary close-modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Question Modal -->
        <div id="add-question-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Question</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="add-question-form">
                        <input type="hidden" id="question-id">
                        <input type="hidden" id="question-value-id">
                        
                        <div class="form-group">
                            <label for="question-text">Question Text</label>
                            <textarea id="question-text" name="question-text" rows="4" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Answer Options</label>
                            <div id="answer-options">
                                <div class="answer-option">
                                    <input type="text" name="answer-text-1" placeholder="Answer text" value="Strongly Agree" required>
                                    <input type="number" name="answer-score-1" placeholder="Score" value="5" min="1" max="5" required>
                                </div>
                                <div class="answer-option">
                                    <input type="text" name="answer-text-2" placeholder="Answer text" value="Agree" required>
                                    <input type="number" name="answer-score-2" placeholder="Score" value="4" min="1" max="5" required>
                                </div>
                                <div class="answer-option">
                                    <input type="text" name="answer-text-3" placeholder="Answer text" value="Neutral" required>
                                    <input type="number" name="answer-score-3" placeholder="Score" value="3" min="1" max="5" required>
                                </div>
                                <div class="answer-option">
                                    <input type="text" name="answer-text-4" placeholder="Answer text" value="Disagree" required>
                                    <input type="number" name="answer-score-4" placeholder="Score" value="2" min="1" max="5" required>
                                </div>
                                <div class="answer-option">
                                    <input type="text" name="answer-text-5" placeholder="Answer text" value="Strongly Disagree" required>
                                    <input type="number" name="answer-score-5" placeholder="Score" value="1" min="1" max="5" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="save-question-button" class="btn primary">Save</button>
                            <button type="button" class="btn secondary close-modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Add Employee Modal -->
        <div id="add-employee-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Employee</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="add-employee-form">
                        <input type="hidden" id="employee-id">
                        
                        <div class="form-group">
                            <label for="employee-name">Name</label>
                            <input type="text" id="employee-name" name="employee-name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="employee-email">Email</label>
                            <input type="email" id="employee-email" name="employee-email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="employee-position">Position</label>
                            <input type="text" id="employee-position" name="employee-position" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="employee-department">Department</label>
                            <input type="text" id="employee-department" name="employee-department" required>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="save-employee-button" class="btn primary">Save</button>
                            <button type="button" class="btn secondary close-modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Create Survey Modal -->
        <div id="create-survey-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create Survey</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="create-survey-form">
                        <div class="form-group">
                            <label for="survey-title">Survey Title</label>
                            <input type="text" id="survey-title" name="survey-title" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="survey-description">Description</label>
                            <textarea id="survey-description" name="survey-description" rows="4" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="survey-employee">Employee</label>
                            <select id="survey-employee" name="survey-employee" required>
                                <option value="">Select an employee</option>
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="send-survey-button" class="btn primary">Create & Send</button>
                            <button type="button" class="btn secondary close-modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-confirmation-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Confirm Deletion</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="delete-confirmation-message">Are you sure you want to delete this item?</p>
                    
                    <div class="form-actions">
                        <button type="button" id="confirm-delete-button" class="btn danger">Delete</button>
                        <button type="button" class="btn secondary close-modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Survey Results Modal -->
        <div id="survey-results-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Survey Results</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="survey-results-container">
                        <div class="loading-indicator">
                            <div class="spinner"></div>
                            <p>Loading results...</p>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="print-results-button" class="btn primary">Print Results</button>
                        <button type="button" class="btn secondary close-modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>&copy; 2025 ValuesAlign. All rights reserved. <span id="app-version">v1.9.6</span></p>
        </footer>
    </div>
    
    <!-- Scripts -->
    <script src="js/lib/config.js?v=1.9.6&t=20250321210000"></script>
    <script src="js/lib/github-api.js?v=1.9.6&t=20250321210000"></script>
    <script src="js/customer-admin.js?v=1.9.6&t=20250321210000"></script>
    <script>
        // Global variables
        let customerId = null;
        let companyName = '';
        let githubAPI = null;
        let valuesData = [];
        let questionsData = [];
        let employeesData = [];
        let surveysData = [];
        let currentValueId = null;
        let currentEmployeeId = null;
        let currentSurveyId = null;
        let currentQuestionId = null;
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing customer admin dashboard v1.9.6...');
            
            // Set version in footer
            const versionElement = document.getElementById('app-version');
            if (versionElement) {
                versionElement.textContent = 'v1.9.6';
                console.log('Set version to:', 'v1.9.6');
            }
            
            // Get customer ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            customerId = urlParams.get('id');
            
            if (!customerId) {
                showError('Customer ID not found in URL. Please access this page from the master admin dashboard.');
                return;
            }
            
            // Set company name if available in localStorage
            companyName = localStorage.getItem('current_customer_name') || 'Your Company';
            document.getElementById('company-name').textContent = companyName;
            
            // Set up login button event listener
            document.getElementById('login-button').addEventListener('click', handleLogin);
            
            // Check if user is already logged in
            checkLoginStatus();
        });
        
        /**
         * Handle login form submission
         */
        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const token = document.getElementById('github-token').value.trim();
            
            console.log('Login attempt with:', { email, token: token ? 'provided' : 'not provided' });
            
            if (!email || !password || !token) {
                showError('Please enter your email, password, and GitHub token.');
                return;
            }
            
            // Initialize GitHub API
            githubAPI = new GitHubAPI({
                token: token,
                owner: config.github.owner,
                repo: config.github.repo,
                branch: config.github.branch
            });
            
            console.log('GitHub API initialized with config:', {
                owner: config.github.owner,
                repo: config.github.repo,
                branch: config.github.branch
            });
            
            // Test GitHub API connection
            try {
                console.log('Testing GitHub API connection...');
                // Use testAccess instead of testConnection
                const isValid = await githubAPI.testAccess();
                console.log('GitHub API connection test result:', isValid);
                
                if (isValid) {
                    // Verify customer admin credentials
                    console.log('Verifying customer admin credentials...');
                    const isAuthorized = await verifyCustomerAdmin(email, password);
                    console.log('Customer admin verification result:', isAuthorized);
                    
                    if (isAuthorized) {
                        // Save credentials to localStorage
                        localStorage.setItem('github_token', token);
                        localStorage.setItem('customer_admin_email', email);
                        console.log('Credentials saved to localStorage');
                        
                        // Show dashboard
                        showDashboard(email);
                        
                        // Load data
                        loadAllData();
                    } else {
                        showError('Invalid email or password.');
                    }
                } else {
                    showError('Invalid GitHub token or repository access.');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Error connecting to GitHub: ' + error.message);
            }
        }
        
        /**
         * Show an error message
         * @param {string} message - The error message to display
         */
        function showError(message) {
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.textContent = message;
            
            // Remove any existing error messages
            const existingErrors = document.querySelectorAll('.error-message');
            existingErrors.forEach(error => error.remove());
            
            // Add the new error message
            const loginForm = document.getElementById('login-form');
            loginForm.insertBefore(errorElement, loginForm.firstChild);
            
            // Remove the error message after 5 seconds
            setTimeout(() => {
                errorElement.remove();
            }, 5000);
        }
        
        /**
         * Show the dashboard
         * @param {string} email - The admin email to display
         */
        function showDashboard(email) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
        }
        
        /**
         * Check if the user is already logged in
         */
        function checkLoginStatus() {
            const token = localStorage.getItem('github_token');
            const email = localStorage.getItem('customer_admin_email');
            
            if (token && email) {
                // Initialize GitHub API
                githubAPI = new GitHubAPI({
                    token: token,
                    owner: config.github.owner,
                    repo: config.github.repo,
                    branch: config.github.branch
                });
                
                // Show dashboard
                showDashboard(email);
                
                // Load data
                loadAllData();
            }
        }
        
        /**
         * Load all data for the dashboard
         */
        async function loadAllData() {
            // Load values data
            await loadValuesData();
            
            // Load questions data
            await loadQuestionsData();
            
            // Load employees data
            await loadEmployeesData();
            
            // Load surveys data
            await loadSurveysData();
        }
        
        /**
         * Verify customer admin credentials
         * @param {string} email - The admin email
         * @param {string} password - The admin password
         * @returns {Promise<boolean>} - Promise resolving to true if authorized, false otherwise
         */
        async function verifyCustomerAdmin(email, password) {
            try {
                // Get customers data from GitHub
                const customersResponse = await githubAPI.getFileContent('data/customers.json');
                const customers = JSON.parse(atob(customersResponse.content));
                
                console.log('Customers data:', customers);
                
                // Find customer by ID
                const customer = customers.find(c => c.id === customerId);
                
                if (!customer) {
                    console.error('Customer not found:', customerId);
                    return false;
                }
                
                console.log('Found customer:', customer);
                
                // Verify admin credentials
                if (customer.adminEmail === email && customer.adminPassword === password) {
                    // Store company name
                    companyName = customer.name;
                    document.getElementById('company-name').textContent = companyName;
                    localStorage.setItem('current_customer_name', companyName);
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Error verifying customer admin:', error);
                return false;
            }
        }
    </script>
</body>
</html>
